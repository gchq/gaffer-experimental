/* * Copyright 2021-2022 Crown Copyright * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package uk.gov.gchq.gaffer.gaas.client.graph;import io.fabric8.kubernetes.api.model.apps.Deployment;import io.fabric8.kubernetes.client.DefaultKubernetesClient;import io.fabric8.kubernetes.client.KubernetesClient;import io.kubernetes.client.openapi.ApiException;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.scheduling.annotation.Scheduled;import org.springframework.stereotype.Component;import uk.gov.gchq.gaffer.gaas.exception.GaaSRestApiException;import uk.gov.gchq.gaffer.gaas.handlers.DeploymentHandler;import java.text.SimpleDateFormat;import java.util.Calendar;import java.util.Date;import java.util.List;import static uk.gov.gchq.gaffer.gaas.factories.GaaSRestExceptionFactory.from;import static uk.gov.gchq.gaffer.gaas.util.Properties.NAMESPACE;@Componentpublic class GraphAutoDestroy {    @Autowired    private DeploymentHandler deploymentHandler;    @Scheduled(cron = "0 0/51 * * * ?")    public void cronJobSch() throws GaaSRestApiException {        KubernetesClient kubernetesClient = new DefaultKubernetesClient();        try {            List<Deployment> deploymentList = kubernetesClient.apps().deployments().inNamespace(NAMESPACE).list().getItems();            if (!deploymentList.isEmpty()) {                Date today = new Date();                Calendar cal = Calendar.getInstance();                cal.setTime(today);                Date modifiedDate = cal.getTime();                SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");                String dateStr = f.format(modifiedDate);                for (final Deployment deployment : deploymentList) {                    if (deployment.getMetadata().getLabels().get("deleteGraph") != null && deployment.getMetadata().getLabels().get("deleteGraph").equals(dateStr)) {                       boolean done = deploymentHandler.onGafferDelete(deployment.getMetadata().getLabels().get("app.kubernetes.io/instance"), kubernetesClient);                    }                }            }        } catch (ApiException e) {            throw from(e);        }    }}